# 01、类生命周期

在 Java 代码中，类型的加载、连接与初始化过程都是在程序运行期间完成的。这种机制提供了更大的灵活性，增加了更多的可能性。

> JDK 动态代理，在运行期生成代理类，通过类加载器加载。

## Java虚拟机与程序生命周期

- Java虚拟机结束生命周期的情况
  - 执行了 `System.exit()` 方法
  - 程序正常执行结束
  - 程序执行过程中遇到了异常或错误而终止
  - 由于操作系统出现错误导致Java 虚拟机线程终止

## 类加载生命周期

1. <font color='orange'>加载</font>：查找并加载类的二进制数据
2. <font color='orange'>连接</font>：
   - <font color='orange'>验证</font>：确保被加载的类的正确性
   - <font color='orange'>准备</font>：为类的静态变量分配内存，并将期初始化为默认值（<font color='orange'>零值</font>）
   - <font color='orange'>解析</font>：把类种的符合引用转换为直接应用
3. <font color='orange'>初始化</font>：为类的静态变量赋予正确的初始值
4. <font color='orange'>使用</font>：我们接触最多的一个状态
5. <font color='orange'>卸载</font>：从类加载器中移除类二进制数据

### 类的初始化

触发条件：所有的Java虚拟机实现必须在每个类或者接口被Java程序<font color='orange'>首次主动使用</font>时才会被初始化

### 对类使用的两种方式

- 主动使用
  - 创建类的实例（new）
  - 访问某一个类或者接口的静态变量，或者对该静态变量赋值
  - 调用该类的静态方法
  - 反射
  - 初始化一个类的子类
  - Java 虚拟机启动时被标明为启动类的类（main（））
  - JDK1.7开发提供动态语言支持，java.lang.invoke.MethodHandle 实例解析结果 REF_getStatic、REF_putStatic、REF_invokeStatic 对应的类如果没有初始化则初始化
- 被动使用
  - 其他情况都是被动使用

> 主动使用分类：
>
> 1、创建对象：包含 new 、反射
>
> 2、静态变量：有 static 关键字
>
> 3、关联：子类初始化会先初始父类



## 类实例化

类的生命周期在<font color='orange'>使用</font>阶段，会有<font color='orange'>类的实例化</font>，主要完成以下工作

- 为新对象分配内存
- 为实例变量赋默认值
- 为实例变量赋正确的初始值

Java 编译器为它每一个类都至少生成一个实例初始化方法，在 Java 的 class 文件中，这个实例初始化方法称为 `<init>`,一个构造方法对应一个 `<init>`



## 类的加载

### 类存放的位置

类加载指的是将类的 `.class` 文件种的二进制数据读入到内存中，将其放在运行时数据区的方法区内，然后在内存中创建一个 `java.lang.Class` 对象（规范并未说明 Class 对象位于那里，HotSpot 虚拟机将其放在了方法区中）用来封装类在方法区的数据结构

### 类加载来源

- 从本地系统中直接加载
- 从网络下载 `.class` 文件
- 从 zip、 jar 等归档文件中 加载
- 从专有数据库中加载
- 将Java源文件动态编译为 `.class` 文件（JDK 动态代理）



### 类加载的时机

类加载器并不需要等到某个类被“首次主动使用”时加载它。

JVM 规范允许类加载器在预料某个类将要被使用时就预先加载它，如果预先加载的过程中遇到了 `.class` 文件缺失或者存在错误，类加载器必须在程序<font color='orange'>首次主动使用</font>该类的时候才报告错误（<font color='red'>LinkageError</font>）。如果该类一直没有被程序主动使用，那么类加载器就不会报告错误

## 类的验证

类被加载后，就进入了连接阶段。连接就是将已经读入到内存的类的二进制数据合并到虚拟机的运行时环境中去，主要有以下验证：

- 类文件的结构检查
- 语义检查
- 字节码检查
- 二进制兼容性验证

## 类的准备

类在准备阶段，Java 虚拟机为类的静态变量分配内存，并设置默认的初始值（<font color='orange'>零值</font>）

## 类的初始

- 如果该类未被加载和连接，需要先进行加载和连接
- 如果该类存在父类，并且父类还没有被初始化，那就先初始化父类
  - 在初始化一个类时，并不会先初始化它的所实现的接口
  - 在初始化一个接口时，并不会先初始化它的父接口
- 如果类中存在初始化语句，依次执行这些初始化语句

## 类的卸载

当类被加载、连接、初始化后，它的生命就开始了。类的 Class 对象不在被引用，即不可触及时，Class  对象就会结束生命周期,类在方法区内的数据也会被卸载，从而结束类的生命周期。

总的来说，一个类何时结束生命周期，取决于代表它的 Class 对象何时结束生命周期

- 有 JAVA 虚拟机自带的类加载器所加载器的类，在虚拟机的生命周期中，始终不会被卸载。因为 Java 虚拟机始终会引用这些类加载器，而这些类加载器始终会引用他们加载的 Class 对象，因此这些类是可触及的。
- 由用户自定义的类加载器所加载的类是可以被卸载的

