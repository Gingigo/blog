# 一条SQL查询语句是如何执行的？

我们以一条简单的查询语句为例？

```mysql
mysql> select * from T where id = 10;
```

我们更多的时候是只看到这只是一条语句，返回一个结果，却不知道这条语句在MySQL内部的执行过程。

很高兴能接触到MySQL45讲这门课程让我受益良多，接下来我就跟着丁奇老师来学习MySQL的知识。



![image text](https://raw.githubusercontent.com/dddygin/image-storage/main/blog/image/database/mysql/mysql45/mysql45-01-01.gif)

<div align=center style="color:#888888;">MySQL逻辑架构图</div>
MySQL 可以分成Server层和存储引擎两大部分

- Server层包括连接器、查询缓存（mysql8已经删除）、分析器、优化器、执行器等，涵盖MySQL的大多数核心服务功能，以及所有内置函数（如：日期、时间、数字、加密函数），所有跨存储引擎的功能都在这里实现比如：存储过程、触发器、视图等。

- 存储引擎层负责数据额存储和提取。其架构模式是插件式式的，支持InnoDB、MyISAM、Memory等多个存储引擎。现在最常见的式InnoDB，它从MySQL5.5.5版本开始成为默认存储引擎。

## 连接器

第一步，连接数据库第一个模块式连接器，连接器负责跟客户端建立连接、获取权限、维持和管理连接。

```mysql
mysql -h$ip -P$port -u$user -p
-- 如本地连接：
-- mysql -h127.0.0.1 -P3306 -uroot -p
```

> 不建议-p后面直接跟密码，防止密码泄露

连接命令中的**mysql**是客户端工具用来和服务端建立连接，在完成完经典的TCP握手之后连接器就会开始认证输入的用户名和密码。

- 如密码不正确就会收到”Access denied for user“ 的错误，客户端结束执行
- 如果用户名密码认证通过连接器就会到权限表中查找当前用户的拥有的权限，之后的权限验证都要依赖此时读到的权限。

这个就意味如果一个用户已经成功建立连接，即使管理员修改这个用户的权限，也不会影响本次连接的权限，修改权限完成后，需要重新连接才会生效。

连接完成后如果没有后续的动作连接就会处于空闲状态，可以使用`show processlist`命令查看连接，在Command列相似为"Sleep"的这一行表示当前连接空闲。

![image text](https://raw.githubusercontent.com/dddygin/image-storage/main/blog/image/database/mysql/mysql45/mysql45-01-02.gif)

如果时间太长没有进行操作，连接器就会自动断开，这个时间的参数是由wait_timeout控制的，默认值是8小时

```mysql
-- 查看 wait_timeout
show global variables like 'wait_timeout';
-- 修改 wait_timeout
set global wait_timeout=14400;
```

![image text](https://raw.githubusercontent.com/dddygin/image-storage/main/blog/image/database/mysql/mysql45/mysql45-01-03.gif)

如果连接被断开之后，客户端在发送请求就和收到一个 ”Lost connection to MySQL server during query"的错误，这时需要重连再执行请求。

### 长短连接

- 长连接是指连接成功后，如果客户端持续有请求，则一直使用同一个连接
- 短连接则指每一次执行完成很少的几次查询就端口连接，下一次查询就要重新新建一个

建立连接的过程是比较复杂，所有我们在使用的过程中要尽量是用长连接。

但是全部使用长连接可能会导致MySQL占用内存涨的特别快，这时因为MySQL中在执行过程中使用的内存是管理在连接对象里面的，这些资源只有在断开连接的时间才会释放。所以如果长连接累积下来，可能导致内存占用太大，被系统强行杀到，从现象看就是MySQL异常重启了

解决长连接内存占用大的方案：

1. 定期断开长连接。使用一段时间，或者程序里面执行过一个大内存的查询后，端口连接，之后要查询再重连（定时断开/查询大数据断开）
2. 如果是MySQL5.7+，就可以在每次执行完成一个较大的操作后，通过执行mysql_reset_connection 来重新初始化连接资源，这个过程不需要重连和重新做权限验证，但是会将连接恢复到刚刚创建的状态。

> mysql_reset_connection 是mysql为各种编程语言提供的api（C语言api） 不是MySQL内置语句或者语句



## 查询缓存

连接建立完成之后，就可执行select语句了，执行逻辑来到的第二部：查询缓存

MySQL 拿到查询缓存请求后，会先到查询缓存看看，是否之前有执行过这条语句。因为之前执行过的语句会以key-value对的形式被缓存在内存中。key：语句，value：返回的数据。如果能够找到对应的语句key，那么value结果就直接返回给客户端。

如果没有命中缓存的，就要往下执行，执行完成后，返回的结果将会被存到查询缓存中，如果命中缓存就不需要执行后面的流程就可以直接返回给客户端，这个效率很高。

**但大多数状态下我们是不建议使用查询缓存的，因为利大于弊**

查询缓存失效时非常频繁的，只要对一个表进行更新，这个表上的查询缓存将会全部被情空，对于更新频繁的数据库来说，命中查询缓存的概率时特别低的。除非你的业务时张静态表，很长时间才更新一次，如系统配置表。

MySQL也提供了“按需使用”方式 可以将query_cache_type设置为DEMAND，这样数据就默认不会使用查询缓存，而需要查询缓存的可以通过SQL_CACHE显示指定

```mysql
select SQL_CACHE * from T where id>1;
```

需要注意的时MySQL8.0开始删除了查询缓存整一个模块

> （工程实现上，如果命中查询缓存，就会在返回结果的时候做权限验证）
>

## 分析器

没有命中查询缓存所以要进入下个逻辑模块，分析器。

分析器会先做“词法分析”。输入的sql是由那些字符串组成，如识别到“select”关键字就是查询语句，识别到 T 就是表T等等。

做完词法分析就要做“语法分析” 根据词法分析获取的结果检查语法是否符合MySQL语法

语义分析，判断是否有权限访问该表，或者表/列存不存在等

如果语法不对就会收到 You hava an error in your SQL syntax的错误

一般语法的第一个错误位置是“use near”之后

> 分析器也会进行precheck权限验证，判断是否对该表拥有操作权限

## 优化器

经过了分析的检验，在进入执行前需要进如优化器。

优化器是在表里面由多个索引的时候，决定用那个索引；或者一个语句有多个表join的时候各表的连接顺序 如下面的例子

```mysql
mysql> select * from t1 join t2 using(id) where t1.c=10 and t2.d=20;
```

先取t1表中的数据和先取t2表中的数据效率是不同的（如先取t1 假设是10，关联t2是100；先取t2是100 关联t1是10条）

## 执行器

通过优化器的优化终于进入了执行器执行我们的sql了

在开始执行的时候要先判断你对这个表T有没有执行查询的条件，如果没有就会返回没有权限的错误。

如果有权限，就打开表继续执行。打开表的时候执行器就会根据表的引擎定义去使用这个引擎提供的接口


## 自问自答
1. 为什么所有跨存储引擎、内置函数要设计在Server层？
    答：存储Server层与存储引擎对接的方式是以接口方式对接的，每一种引擎去实现Server层的接口，这样用户将不关心因引擎不同导致sql的写法不同，也使存储引擎变成一种插件式，这样更好扩展。这样就比较好理解所有跨存储引擎功能要放在Server层了，因为不同的表存储引擎可能不同所以调用的规则可能不同，如果式放在Server就能很好的解决这个问题，直接调用存储引擎接口就可以；而内置函数也是放在Server层也是比较合理的，存储引擎主要是负责数据的存储和提取，而不是处理数据的，如果在Server层做处理就能忽略数据表是什么引擎，因为数据引擎返回统一的数格式，只要加一个函数处理功能就能对所有数据进行处理。

2. 如果user1第一次连接上数据库执行`select * from T`,管理员修改权限user1的权限不能访问T表，user1重连执行`select * from T` 会返回结果吗？

     答：不会，因为在命中查询缓存，会在查询缓存返回结果的时候做权限验证

3. 分析器执行了precheck权限验证和执行器执行了权限验证是否重复了？

     答：不会，在sql执行过程中,可能会有触发器这种运行时才能确定是否有相应的权限操作，分析器工作结束后的precheck操作是不能对这种运行时涉及到表进行权限校验的，所以需要在执行器阶段进行权限检查。另外也是因为precheck这个步骤，才会报错显示用户无权限，而不是字段k不存在，这样做时防止暴露表结构

4. 表结构放在哪里？

     答：词法分析阶段时从information_schema中获取表结构的

5. 如何设置长短连接？
     答：长短连接不是设置的，而是“行为”，查完就断开就是短连接，查完不断开，下次继续查就是长连接

     
